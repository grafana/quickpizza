# NOTE:
# It is important that these actions are run for every PR, no matter what
# other actions are added. The ones here are testing the actual code pushed
# instead of a possibly outdated image. Additionally, we also run formatters
# and linters here.
# Do not modify this file unless you really need to. You very likely don't need to.

name: Build and Test (without Docker)
on: [push]

permissions:
  contents: read

jobs:
  runner-job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5

      - name: Setup Goimports
        run: go install golang.org/x/tools/cmd/goimports@latest

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22

      - name: Check Formatting (Go)
        run: make format-check

      - name: Build Binary
        run: make build

      - name: Run Biome Checks
        run: cd pkg/web && npm run biome-check

      - name: Start Server
        # Use enable these features in our own deployment, so we might as well
        # "enable" them during testing as well to simulate a more realistic setup.
        env:
          QUICKPIZZA_OTLP_ENDPOINT: "http://localhost"
          QUICKPIZZA_TRUST_CLIENT_TRACEID: "1"
          QUICKPIZZA_PYROSCOPE_ENDPOINT: "http://localhost"
        run: ./bin/quickpizza &

      - name: Setup k6
        uses: grafana/setup-k6-action@ffe7d7290dfa715e48c2ccc924d068444c94bde2 # v1

      - name: Install jq
        uses: dcarbone/install-jq-action@e397bd87438d72198f81efd21f876461183d383a # v3.0.1

      - name: Run k6 foundations tests
        run: ./scripts/run-tests.sh -t **/k6/foundations/*.js -u http://localhost:3333

      - name: Run k6 foundations TS tests
        run: ./scripts/run-tests.sh -t **/k6/foundations/*.ts -u http://localhost:3333

      - name: Run k6 internal tests
        run: ./scripts/run-tests.sh -t **/k6/internal/*.js -u http://localhost:3333

      - name: Run k6 browser tests
        run: ./scripts/run-tests.sh -t **/k6/browser/*.js -u http://localhost:3333

      - name: Stop Server
        run: pkill -9 quickpizza
